<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
<head>
  <meta content="text/html; charset=UTF-8" http-equiv="Content-Type" />

  <title>Module: RabbitMQ</title>

  <link rel="stylesheet" href="./rdoc.css" type="text/css" media="screen" />

  <script src="./js/jquery.js" type="text/javascript"
    charset="utf-8"></script>
  <script src="./js/thickbox-compressed.js" type="text/javascript"
    charset="utf-8"></script>
  <script src="./js/quicksearch.js" type="text/javascript"
    charset="utf-8"></script>
  <script src="./js/darkfish.js" type="text/javascript"
    charset="utf-8"></script>

</head>
<body class="module">

  <div id="metadata">
    <div id="home-metadata">
      <div id="home-section" class="section">
        <h3 class="section-header">
          <a href="./index.html">Home</a>
          <a href="./index.html#classes">Classes</a>
          <a href="./index.html#methods">Methods</a>
        </h3>
      </div>
    </div>

    <div id="file-metadata">
      <div id="file-list-section" class="section">
        <h3 class="section-header">In Files</h3>
        <div class="section-body">
          <ul>
          
            <li><a href="./lib/rabbitmq_rb.html?TB_iframe=true&amp;height=550&amp;width=785"
              class="thickbox" title="lib/rabbitmq.rb">lib/rabbitmq.rb</a></li>
          
          </ul>
        </div>
      </div>

      
    </div>

    <div id="class-metadata">

      <!-- Parent Class -->
      

      <!-- Namespace Contents -->
      

      <!-- Method Quickref -->
      
      <div id="method-list-section" class="section">
        <h3 class="section-header">Methods</h3>
        <ul class="link-list">
          
          <li><a href="#method-c-erase_local_files">::erase_local_files</a></li>
          
          <li><a href="#method-c-start_master">::start_master</a></li>
          
          <li><a href="#method-c-start_slave">::start_slave</a></li>
          
          <li><a href="#method-c-stop">::stop</a></li>
          
          <li><a href="#method-c-write_cookie">::write_cookie</a></li>
          
        </ul>
      </div>
      

      <!-- Included Modules -->
      
    </div>

    <div id="project-metadata">
      
      

      <div id="classindex-section" class="section project-section">
        <h3 class="section-header">Class/Module Index
          <span class="search-toggle"><img src="./images/find.png"
            height="16" width="16" alt="[+]"
            title="show/hide quicksearch" /></span></h3>
        <form action="#" method="get" accept-charset="utf-8" class="initially-hidden">
        <fieldset>
          <legend>Quicksearch</legend>
          <input type="text" name="quicksearch" value=""
            class="quicksearch-field" />
        </fieldset>
        </form>

        <ul class="link-list">
        
          <li><a href="./AppControllerClient.html">AppControllerClient</a></li>
        
          <li><a href="./BadConfigurationException.html">BadConfigurationException</a></li>
        
          <li><a href="./BlobServer.html">BlobServer</a></li>
        
          <li><a href="./Collectd.html">Collectd</a></li>
        
          <li><a href="./CronHelper.html">CronHelper</a></li>
        
          <li><a href="./Datastore.html">Datastore</a></li>
        
          <li><a href="./DatastoreFactory.html">DatastoreFactory</a></li>
        
          <li><a href="./DatastoreRepo.html">DatastoreRepo</a></li>
        
          <li><a href="./DatastoreRepoOnAppEngine.html">DatastoreRepoOnAppEngine</a></li>
        
          <li><a href="./DatastoreRepoOnAppScale.html">DatastoreRepoOnAppScale</a></li>
        
          <li><a href="./DatastoreS3.html">DatastoreS3</a></li>
        
          <li><a href="./Djinn.html">Djinn</a></li>
        
          <li><a href="./DjinnJobData.html">DjinnJobData</a></li>
        
          <li><a href="./DjinnServer.html">DjinnServer</a></li>
        
          <li><a href="./Ejabberd.html">Ejabberd</a></li>
        
          <li><a href="./EngineFactory.html">EngineFactory</a></li>
        
          <li><a href="./FailedZooKeeperOperationException.html">FailedZooKeeperOperationException</a></li>
        
          <li><a href="./GodInterface.html">GodInterface</a></li>
        
          <li><a href="./GoogleAppEnginePullQueue.html">GoogleAppEnginePullQueue</a></li>
        
          <li><a href="./GoogleAppEnginePushQueue.html">GoogleAppEnginePushQueue</a></li>
        
          <li><a href="./HAProxy.html">HAProxy</a></li>
        
          <li><a href="./HelperFunctions.html">HelperFunctions</a></li>
        
          <li><a href="./JSONClient.html">JSONClient</a></li>
        
          <li><a href="./LoadBalancer.html">LoadBalancer</a></li>
        
          <li><a href="./Monitoring.html">Monitoring</a></li>
        
          <li><a href="./NeptuneJobData.html">NeptuneJobData</a></li>
        
          <li><a href="./Nginx.html">Nginx</a></li>
        
          <li><a href="./Object.html">Object</a></li>
        
          <li><a href="./PbServer.html">PbServer</a></li>
        
          <li><a href="./QueueFactory.html">QueueFactory</a></li>
        
          <li><a href="./RabbitMQ.html">RabbitMQ</a></li>
        
          <li><a href="./Repo.html">Repo</a></li>
        
          <li><a href="./TaskEngine.html">TaskEngine</a></li>
        
          <li><a href="./TaskEngineAppScale.html">TaskEngineAppScale</a></li>
        
          <li><a href="./TaskEngineGoogleAppEngine.html">TaskEngineGoogleAppEngine</a></li>
        
          <li><a href="./TaskQueue.html">TaskQueue</a></li>
        
          <li><a href="./TaskQueueAzureQueue.html">TaskQueueAzureQueue</a></li>
        
          <li><a href="./TaskQueueGoogleAppEngine.html">TaskQueueGoogleAppEngine</a></li>
        
          <li><a href="./TaskQueueRabbitMQ.html">TaskQueueRabbitMQ</a></li>
        
          <li><a href="./TaskQueueSQS.html">TaskQueueSQS</a></li>
        
          <li><a href="./UserAppClient.html">UserAppClient</a></li>
        
          <li><a href="./ZKInterface.html">ZKInterface</a></li>
        
        </ul>
        <div id="no-class-search-results" style="display: none;">No matching classes.</div>
      </div>

      
    </div>
  </div>

  <div id="documentation">
    <h1 class="module">RabbitMQ</h1>

    <div id="description">
      
<p>To implement support for the Google App Engine Task Queue API, we use the
open source rabbitmq server. This lets users dispatch background tasks,
whose data are stored as items in rabbitmq. This module provides methods
that automatically configure and deploy rabbitmq as needed.</p>

    </div>

    <!-- Constants -->
    
    <div id="constants-list" class="section">
      <h3 class="section-header">Constants</h3>
      <dl>
      
        <dt><a name="SERVER_PORT">SERVER_PORT</a></dt>
        
        <dd class="description"><p>The port that the <a href="RabbitMQ.html">RabbitMQ</a> server runs on, by
default.</p></dd>
        
      
        <dt><a name="COOKIE_FILE">COOKIE_FILE</a></dt>
        
        <dd class="description"><p>The path to the file that the shared secret should be written to.</p></dd>
        
      
      </dl>
    </div>
    

    <!-- Attributes -->
    

    <!-- Methods -->
    
    <div id="public-class-method-details" class="method-section section">
      <h3 class="section-header">Public Class Methods</h3>

    
      <div id="erase_local_files-method" class="method-detail ">
        <a name="method-c-erase_local_files"></a>

        
        <div class="method-heading">
          <span class="method-name">erase_local_files</span><span
            class="method-args">()</span>
          <span class="method-click-advice">click to toggle source</span>
        </div>
        

        <div class="method-description">
          
          <p>Erases all the files that <a href="RabbitMQ.html">RabbitMQ</a> normally
writes to, which can be useful to ensure that we start up <a
href="RabbitMQ.html">RabbitMQ</a> without left-over state from previous
runs.</p>
          

          
          <div class="method-source-code"
            id="erase_local_files-source">
<pre>
<span class="ruby-comment"># File lib/rabbitmq.rb, line 83</span>
def self.erase_local_files()
  <span class="ruby-constant">Djinn</span>.log_run(<span class="ruby-string">&quot;rm -rf /var/log/rabbitmq/*&quot;</span>)
  <span class="ruby-constant">Djinn</span>.log_run(<span class="ruby-string">&quot;rm -rf /var/lib/rabbitmq/mnesia/*&quot;</span>)
end</pre>
          </div>
          
        </div>

        

        
      </div>

    
      <div id="start_master-method" class="method-detail ">
        <a name="method-c-start_master"></a>

        
        <div class="method-heading">
          <span class="method-name">start_master</span><span
            class="method-args">()</span>
          <span class="method-click-advice">click to toggle source</span>
        </div>
        

        <div class="method-description">
          
          <p>Starts a service that we refer to as a “rabbitmq_master”, a <a
href="RabbitMQ.html">RabbitMQ</a> service that other nodes can rely on to
be running <a href="RabbitMQ.html">RabbitMQ</a>.</p>
          

          
          <div class="method-source-code"
            id="start_master-source">
<pre>
<span class="ruby-comment"># File lib/rabbitmq.rb, line 26</span>
def self.start_master()
  <span class="ruby-constant">Djinn</span>.log_debug(<span class="ruby-string">&quot;Starting RabbitMQ Master&quot;</span>)
  self.write_cookie()
  self.erase_local_files()
  start_cmd = <span class="ruby-string">&quot;rabbitmq-server -detached -setcookie &quot;</span> +
   &quot;#{HelperFunctions.get_secret()}&quot;
  <span class="ruby-constant">Djinn</span>.log_run(&quot;#{start_cmd}&quot;)
end</pre>
          </div>
          
        </div>

        

        
      </div>

    
      <div id="start_slave-method" class="method-detail ">
        <a name="method-c-start_slave"></a>

        
        <div class="method-heading">
          <span class="method-name">start_slave</span><span
            class="method-args">(master_ip)</span>
          <span class="method-click-advice">click to toggle source</span>
        </div>
        

        <div class="method-description">
          
          <p>Starts a service that we refer to as a “rabbitmq slave”. Since all
nodes in <a href="RabbitMQ.html">RabbitMQ</a> are equal, this name isn’t
exactly fair, so what this role means here is “start a <a
href="RabbitMQ.html">RabbitMQ</a> server and connect it to the server on
the machine playing the ‘rabbitmq_master’ role.”</p>
          

          
          <div class="method-source-code"
            id="start_slave-source">
<pre>
<span class="ruby-comment"># File lib/rabbitmq.rb, line 40</span>
def self.start_slave(master_ip)
  <span class="ruby-constant">Djinn</span>.log_debug(<span class="ruby-string">&quot;Starting RabbitMQ Slave&quot;</span>)
  self.write_cookie()
  self.erase_local_files()
  
  <span class="ruby-comment"># Wait for RabbitMQ on master node to come up</span>
  <span class="ruby-constant">HelperFunctions</span>.sleep_until_port_is_open(master_ip, <span class="ruby-constant">SERVER_PORT</span>)

  <span class="ruby-comment"># start the server, reset it to join the head node</span>
  start_cmds = [&quot;rabbitmq-server -detached -setcookie #{HelperFunctions.get_secret()}&quot;,
               <span class="ruby-string">&quot;rabbitmqctl start_app&quot;</span>,
               <span class="ruby-string">&quot;rabbitmqctl stop_app&quot;</span>,
               <span class="ruby-string">&quot;rabbitmqctl reset&quot;</span>,
               <span class="ruby-string">&quot;rabbitmqctl cluster rabbit@appscale-image0&quot;</span>,
               <span class="ruby-string">&quot;rabbitmqctl start_app&quot;</span>]
  full_cmd = &quot;#{start_cmds.join('; ')}&quot;

  <span class="ruby-constant">Djinn</span>.log_run(&quot;#{full_cmd}&quot;)
  <span class="ruby-constant">HelperFunctions</span>.sleep_until_port_is_open(<span class="ruby-string">&quot;localhost&quot;</span>, <span class="ruby-constant">SERVER_PORT</span>)
end</pre>
          </div>
          
        </div>

        

        
      </div>

    
      <div id="stop-method" class="method-detail ">
        <a name="method-c-stop"></a>

        
        <div class="method-heading">
          <span class="method-name">stop</span><span
            class="method-args">()</span>
          <span class="method-click-advice">click to toggle source</span>
        </div>
        

        <div class="method-description">
          
          <p>Stops the <a href="RabbitMQ.html">RabbitMQ</a> server on this node.
TODO(cgb): It doesn’t actually do anything right now - find out what we
need to do to stop the server.</p>
          

          
          <div class="method-source-code"
            id="stop-source">
<pre>
<span class="ruby-comment"># File lib/rabbitmq.rb, line 65</span>
def self.stop()
  <span class="ruby-constant">Djinn</span>.log_debug(<span class="ruby-string">&quot;Shutting down RabbitMQ&quot;</span>)
end</pre>
          </div>
          
        </div>

        

        
      </div>

    
      <div id="write_cookie-method" class="method-detail ">
        <a name="method-c-write_cookie"></a>

        
        <div class="method-heading">
          <span class="method-name">write_cookie</span><span
            class="method-args">()</span>
          <span class="method-click-advice">click to toggle source</span>
        </div>
        

        <div class="method-description">
          
          <p>Erlang processes use a secret value as a password to authenticate between
one another. Since this is pretty much the same thing we do in AppScale
with our secret key, use the same key here. TODO(cgb): Consider using a
different key, so that if one key is compromised it doesn’t compromise
the other.</p>
          

          
          <div class="method-source-code"
            id="write_cookie-source">
<pre>
<span class="ruby-comment"># File lib/rabbitmq.rb, line 75</span>
def self.write_cookie()
  <span class="ruby-constant">HelperFunctions</span>.write_file(<span class="ruby-constant">COOKIE_FILE</span>, <span class="ruby-constant">HelperFunctions</span>.get_secret())
end</pre>
          </div>
          
        </div>

        

        
      </div>

    
    </div>
  

  </div>

  <div id="validator-badges">
    <p><small><a href="http://validator.w3.org/check/referer">[Validate]</a></small></p>
    <p><small>Generated with the <a href="http://deveiate.org/projects/Darkfish-Rdoc/">Darkfish
      Rdoc Generator</a> 2</small>.</p>
  </div>

</body>
</html>

