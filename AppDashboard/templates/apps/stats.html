<!-- FILE:templates/apps/stats.html -->
<!--Body content-->
<div id="content" class="clearfix">
    <div class="contentwrapper"><!--Content wrapper-->
        <!-- Build page from here: -->
        <div class="row-fluid">
          <div class="span12">
            <div class="page-header">
                <h1>App Console for {{ appid }}</h1>
            </div><!--close header-->
              <div class="row-fluid">
                <div style="margin-right:auto; margin-left:auto;">
                  <p>Requests per second:</p>
                </div><!-- close marginright -->
                <div class="offset1 span8">
                  <div class="flot-container">
                    <div id="requests-per-second-flot" class="flot-placeholder"></div>
		  </div><!-- close request per sec container -->
                </div><!-- close offset -->
              </div><!-- close row fluid-->
              <div class="row-fluid">
                <div style="margin-right:auto; margin-left:auto;">
                  <p>Kind statistics:</p>
                </div><!-- close marginright -->
                <div class="offset1 span8">
                  <div class="flot-container">
                    <div id="kind-flot" class="flot-placeholder"></div>
		  </div><!-- close kind container-->
                </div><!-- close offset -->
              </div><!-- close row fluid-->
        </div><!--close span6 -->
        </div> <!-- end row fluid -->
    </div> <!-- end content wrapper -->
</div> <!--end content-->

<script>
//Plots JSON data on a line graph
window.onload = function() {
  update_request_info();
  update_stats_info();

  setInterval(
    function() {
      update_request_info();
      update_stats_info();
    }, 20000);
}

function update_request_info() {
  $.ajax({
    url: "/apps/stats/requests?appid={{ appid }}",
  }).done(
  function(json_data) {
    var req_info = JSON.parse(json_data);
    var thetuples = [];
    for (var index = 0; index < req_info.length; index++) {
      var x = req_info[index]['timestamp'] * 1000;
      var y = req_info[index]['num_of_requests'];
      thetuples.push([x, y]);
    }

    $.plot($("#requests-per-second-flot"), [thetuples], {
      xaxis: {
        mode: "time",
        timezone: "browser",
        timeformat: "%m/%d %H:%M:%S"
      }
    });
  });
}

function update_stats_info() {
  $.ajax({
    url: "/apps/stats/datastore?appid={{ appid }}",
  }).done(
    function(json_data) {
      var stats_info = JSON.parse(json_data);
      var most_recent_info = stats_info[stats_info.length-1];
      var all_stats = [];
      for (var entity_timestamp in most_recent_info) {
        var entity_stats = most_recent_info[entity_timestamp];
        for (var entity_name in entity_stats) {
          var entity_size = entity_stats[entity_name]["bytes"];
          all_stats.push({ label: entity_name, data: [[1, entity_size]] });
        }
      }

      $.plot('#kind-flot', all_stats, {
        series: {
          pie: {
            show: true
          }
        },
        legend: {
          show: false
        }
      });
    });
}

</script>
