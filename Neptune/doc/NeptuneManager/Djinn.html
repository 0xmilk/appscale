<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
<head>
  <meta content="text/html; charset=UTF-8" http-equiv="Content-Type" />

  <title>Class: NeptuneManager::Djinn</title>

  <link rel="stylesheet" href="../rdoc.css" type="text/css" media="screen" />

  <script src="../js/jquery.js" type="text/javascript"
    charset="utf-8"></script>
  <script src="../js/thickbox-compressed.js" type="text/javascript"
    charset="utf-8"></script>
  <script src="../js/quicksearch.js" type="text/javascript"
    charset="utf-8"></script>
  <script src="../js/darkfish.js" type="text/javascript"
    charset="utf-8"></script>

</head>
<body class="class">

  <div id="metadata">
    <div id="home-metadata">
      <div id="home-section" class="section">
        <h3 class="section-header">
          <a href="../index.html">Home</a>
          <a href="../index.html#classes">Classes</a>
          <a href="../index.html#methods">Methods</a>
        </h3>
      </div>
    </div>

    <div id="file-metadata">
      <div id="file-list-section" class="section">
        <h3 class="section-header">In Files</h3>
        <div class="section-body">
          <ul>
          
            <li><a href="../lib/job_types/babel_helper_rb.html?TB_iframe=true&amp;height=550&amp;width=785"
              class="thickbox" title="lib/job_types/babel_helper.rb">lib/job_types/babel_helper.rb</a></li>
          
          </ul>
        </div>
      </div>

      
    </div>

    <div id="class-metadata">

      <!-- Parent Class -->
      
      <div id="parent-class-section" class="section">
        <h3 class="section-header">Parent</h3>
        
        <p class="link"><a href="../Object.html">Object</a></p>
        
      </div>
      

      <!-- Namespace Contents -->
      

      <!-- Method Quickref -->
      
      <div id="method-list-section" class="section">
        <h3 class="section-header">Methods</h3>
        <ul class="link-list">
          
          <li><a href="#method-c-cleanup">::cleanup</a></li>
          
          <li><a href="#method-c-copy_code_and_inputs_to_dir">::copy_code_and_inputs_to_dir</a></li>
          
          <li><a href="#method-c-copy_code_to_dir">::copy_code_to_dir</a></li>
          
          <li><a href="#method-c-copy_file_to_dir">::copy_file_to_dir</a></li>
          
          <li><a href="#method-c-copy_inputs_to_dir">::copy_inputs_to_dir</a></li>
          
          <li><a href="#method-c-create_temp_dir">::create_temp_dir</a></li>
          
          <li><a href="#method-c-run_code">::run_code</a></li>
          
          <li><a href="#method-c-save_output">::save_output</a></li>
          
          <li><a href="#method-c-write_babel_outputs">::write_babel_outputs</a></li>
          
        </ul>
      </div>
      

      <!-- Included Modules -->
      
    </div>

    <div id="project-metadata">
      
      

      <div id="classindex-section" class="section project-section">
        <h3 class="section-header">Class/Module Index
          <span class="search-toggle"><img src="../images/find.png"
            height="16" width="16" alt="[+]"
            title="show/hide quicksearch" /></span></h3>
        <form action="#" method="get" accept-charset="utf-8" class="initially-hidden">
        <fieldset>
          <legend>Quicksearch</legend>
          <input type="text" name="quicksearch" value=""
            class="quicksearch-field" />
        </fieldset>
        </form>

        <ul class="link-list">
        
          <li><a href="../NeptuneManager.html">NeptuneManager</a></li>
        
          <li><a href="../NeptuneManager/Djinn.html">NeptuneManager::Djinn</a></li>
        
          <li><a href="../BadConfigurationException.html">BadConfigurationException</a></li>
        
          <li><a href="../Datastore.html">Datastore</a></li>
        
          <li><a href="../DatastoreFactory.html">DatastoreFactory</a></li>
        
          <li><a href="../DatastoreRepo.html">DatastoreRepo</a></li>
        
          <li><a href="../DatastoreRepoOnAppEngine.html">DatastoreRepoOnAppEngine</a></li>
        
          <li><a href="../DatastoreRepoOnAppScale.html">DatastoreRepoOnAppScale</a></li>
        
          <li><a href="../DatastoreS3.html">DatastoreS3</a></li>
        
          <li><a href="../Djinn.html">Djinn</a></li>
        
          <li><a href="../EngineFactory.html">EngineFactory</a></li>
        
          <li><a href="../GoogleAppEnginePullQueue.html">GoogleAppEnginePullQueue</a></li>
        
          <li><a href="../GoogleAppEnginePushQueue.html">GoogleAppEnginePushQueue</a></li>
        
          <li><a href="../HelperFunctions.html">HelperFunctions</a></li>
        
          <li><a href="../NeptuneJobData.html">NeptuneJobData</a></li>
        
          <li><a href="../NeptuneManagerServer.html">NeptuneManagerServer</a></li>
        
          <li><a href="../Object.html">Object</a></li>
        
          <li><a href="../QueueFactory.html">QueueFactory</a></li>
        
          <li><a href="../TaskEngine.html">TaskEngine</a></li>
        
          <li><a href="../TaskEngineAppScale.html">TaskEngineAppScale</a></li>
        
          <li><a href="../TaskEngineGoogleAppEngine.html">TaskEngineGoogleAppEngine</a></li>
        
          <li><a href="../TaskQueue.html">TaskQueue</a></li>
        
          <li><a href="../TaskQueueAzureQueue.html">TaskQueueAzureQueue</a></li>
        
          <li><a href="../TaskQueueGoogleAppEngine.html">TaskQueueGoogleAppEngine</a></li>
        
          <li><a href="../TaskQueueRabbitMQ.html">TaskQueueRabbitMQ</a></li>
        
          <li><a href="../TaskQueueSQS.html">TaskQueueSQS</a></li>
        
          <li><a href="../UserAppClient.html">UserAppClient</a></li>
        
        </ul>
        <div id="no-class-search-results" style="display: none;">No matching classes.</div>
      </div>

      
    </div>
  </div>

  <div id="documentation">
    <h1 class="class">NeptuneManager::Djinn</h1>

    <div id="description">
      
    </div>

    <!-- Constants -->
    

    <!-- Attributes -->
    

    <!-- Methods -->
    
    <div id="public-class-method-details" class="method-section section">
      <h3 class="section-header">Public Class Methods</h3>

    
      <div id="cleanup-method" class="method-detail ">
        <a name="method-c-cleanup"></a>

        
        <div class="method-heading">
          <span class="method-name">cleanup</span><span
            class="method-args">(dir)</span>
          <span class="method-click-advice">click to toggle source</span>
        </div>
        

        <div class="method-description">
          
          
          

          
          <div class="method-source-code"
            id="cleanup-source">
<pre>
<span class="ruby-comment"># File lib/job_types/babel_helper.rb, line 564</span>
def self.cleanup(dir)
  <span class="ruby-constant">NeptuneManager</span>.log(&quot;Cleaning up directory #{dir}&quot;)
  <span class="ruby-comment"># don't clean up if we want to debug the system</span>
  return if <span class="ruby-constant">DEBUG</span>
  <span class="ruby-constant">FileUtils</span>.rm_rf(dir)
end</pre>
          </div>
          
        </div>

        

        
      </div>

    
      <div id="copy_code_and_inputs_to_dir-method" class="method-detail ">
        <a name="method-c-copy_code_and_inputs_to_dir"></a>

        
        <div class="method-heading">
          <span class="method-name">copy_code_and_inputs_to_dir</span><span
            class="method-args">(job_data, dir)</span>
          <span class="method-click-advice">click to toggle source</span>
        </div>
        

        <div class="method-description">
          
          
          

          
          <div class="method-source-code"
            id="copy_code_and_inputs_to_dir-source">
<pre>
<span class="ruby-comment"># File lib/job_types/babel_helper.rb, line 390</span>
def self.copy_code_and_inputs_to_dir(job_data, dir)
  input_storage_start_time = <span class="ruby-constant">Time</span>.now
  <span class="ruby-constant">Djinn</span>.copy_code_to_dir(job_data, dir)
  <span class="ruby-constant">Djinn</span>.copy_inputs_to_dir(job_data, dir)
  input_storage_end_time = <span class="ruby-constant">Time</span>.now
  job_data[<span class="ruby-string">'@metadata_info'</span>][<span class="ruby-string">'input_storage_time'</span>] = input_storage_end_time - input_storage_start_time
end</pre>
          </div>
          
        </div>

        

        
      </div>

    
      <div id="copy_code_to_dir-method" class="method-detail ">
        <a name="method-c-copy_code_to_dir"></a>

        
        <div class="method-heading">
          <span class="method-name">copy_code_to_dir</span><span
            class="method-args">(job_data, dir)</span>
          <span class="method-click-advice">click to toggle source</span>
        </div>
        

        <div class="method-description">
          
          
          

          
          <div class="method-source-code"
            id="copy_code_to_dir-source">
<pre>
<span class="ruby-comment"># File lib/job_types/babel_helper.rb, line 398</span>
def self.copy_code_to_dir(job_data, dir)
  if !is_storage_location?(job_data[<span class="ruby-string">'@code'</span>])
    abort(&quot;The given code, #{job_data['@code']}, is not something we can fetch&quot;)
  end

  <span class="ruby-constant">NeptuneManager</span>.log(&quot;old code is #{job_data['@code']}&quot;)
  local_folder = self.copy_file_to_dir(<span class="ruby-constant">File</span>.dirname(job_data[<span class="ruby-string">'@code'</span>]), dir, job_data)
  job_data[<span class="ruby-string">'@code'</span>] = local_folder + <span class="ruby-string">'/'</span> + <span class="ruby-constant">File</span>.basename(job_data[<span class="ruby-string">'@code'</span>])

  <span class="ruby-comment"># If the code isn't going to be executed by a different program (e.g., python)</span>
  <span class="ruby-comment"># then we need to make it executable</span>
  if job_data[<span class="ruby-string">&quot;@executable&quot;</span>].nil? or job_data[<span class="ruby-string">&quot;@executable&quot;</span>].empty?
    <span class="ruby-constant">NeptuneManager</span>.log(<span class="ruby-string">&quot;making code executable&quot;</span>)
    <span class="ruby-constant">Djinn</span>.log_run(&quot;chmod +x #{job_data['@code']}&quot;)
  end

  <span class="ruby-constant">NeptuneManager</span>.log(&quot;new code is #{job_data['@code']}&quot;)
  return job_data[<span class="ruby-string">'@code'</span>]
end</pre>
          </div>
          
        </div>

        

        
      </div>

    
      <div id="copy_file_to_dir-method" class="method-detail ">
        <a name="method-c-copy_file_to_dir"></a>

        
        <div class="method-heading">
          <span class="method-name">copy_file_to_dir</span><span
            class="method-args">(remote, local, job_data)</span>
          <span class="method-click-advice">click to toggle source</span>
        </div>
        

        <div class="method-description">
          
          
          

          
          <div class="method-source-code"
            id="copy_file_to_dir-source">
<pre>
<span class="ruby-comment"># File lib/job_types/babel_helper.rb, line 439</span>
def self.copy_file_to_dir(remote, local, job_data)
  bucket, file = <span class="ruby-constant">DatastoreS3</span>.parse_s3_key(remote)
  remote_dir = file
  local_file = <span class="ruby-constant">File</span>.expand_path(local + <span class="ruby-string">&quot;/&quot;</span> + remote_dir)
  <span class="ruby-constant">NeptuneManager</span>.log(&quot;downloading remote file #{remote} to local location #{local_file}&quot;)
  <span class="ruby-constant">NeptuneManager</span>.log(&quot;bucket is #{bucket}, file is #{file}&quot;)

  datastore = <span class="ruby-constant">DatastoreFactory</span>.get_datastore(job_data[<span class="ruby-string">'@storage'</span>], job_data)
  datastore.get_output_and_save_to_fs(remote, local)
  return local_file
end</pre>
          </div>
          
        </div>

        

        
      </div>

    
      <div id="copy_inputs_to_dir-method" class="method-detail ">
        <a name="method-c-copy_inputs_to_dir"></a>

        
        <div class="method-heading">
          <span class="method-name">copy_inputs_to_dir</span><span
            class="method-args">(job_data, dir)</span>
          <span class="method-click-advice">click to toggle source</span>
        </div>
        

        <div class="method-description">
          
          
          

          
          <div class="method-source-code"
            id="copy_inputs_to_dir-source">
<pre>
<span class="ruby-comment"># File lib/job_types/babel_helper.rb, line 419</span>
def self.copy_inputs_to_dir(job_data, dir)
  return if job_data[<span class="ruby-string">'@argv'</span>].class != <span class="ruby-constant">Array</span>

  new_argv = []

  <span class="ruby-constant">NeptuneManager</span>.log(&quot;old argv is #{job_data['@argv'].join(' ')}&quot;)
  job_data[<span class="ruby-string">'@argv'</span>].each { |arg|
    if is_storage_location?(arg)
      new_argv &lt;&lt; self.copy_file_to_dir(arg, dir, job_data)
    else
      new_argv &lt;&lt; arg
    end
  }

  job_data[<span class="ruby-string">'@argv'</span>] = new_argv
  <span class="ruby-constant">NeptuneManager</span>.log(&quot;new argv is #{job_data['@argv'].join(' ')}&quot;)
  return
end</pre>
          </div>
          
        </div>

        

        
      </div>

    
      <div id="create_temp_dir-method" class="method-detail ">
        <a name="method-c-create_temp_dir"></a>

        
        <div class="method-heading">
          <span class="method-name">create_temp_dir</span><span
            class="method-args">()</span>
          <span class="method-click-advice">click to toggle source</span>
        </div>
        

        <div class="method-description">
          
          
          

          
          <div class="method-source-code"
            id="create_temp_dir-source">
<pre>
<span class="ruby-comment"># File lib/job_types/babel_helper.rb, line 383</span>
def self.create_temp_dir()
  dir = &quot;/tmp/babel-#{rand(10000)}/&quot;
  <span class="ruby-constant">FileUtils</span>.mkdir_p(dir)
  return dir
end</pre>
          </div>
          
        </div>

        

        
      </div>

    
      <div id="run_code-method" class="method-detail ">
        <a name="method-c-run_code"></a>

        
        <div class="method-heading">
          <span class="method-name">run_code</span><span
            class="method-args">(job_data, dir)</span>
          <span class="method-click-advice">click to toggle source</span>
        </div>
        

        <div class="method-description">
          
          
          

          
          <div class="method-source-code"
            id="run_code-source">
<pre>
<span class="ruby-comment"># File lib/job_types/babel_helper.rb, line 452</span>
def self.run_code(job_data, dir)
  filename_to_exec = job_data[<span class="ruby-string">'@code'</span>]

  executable = job_data[<span class="ruby-string">'@executable'</span>] || <span class="ruby-string">&quot;&quot;</span>

  <span class="ruby-comment"># If the user specifies an argv to pass to the code to exec, be sure to</span>
  <span class="ruby-comment"># capture it and pass it along</span>
  if job_data[<span class="ruby-string">&quot;@argv&quot;</span>]
    argv = job_data[<span class="ruby-string">&quot;@argv&quot;</span>].join(<span class="ruby-string">' '</span>)
    <span class="ruby-comment"># TODO(cgb): filter out colons and other things that malicious users could</span>
    <span class="ruby-comment"># use to hijack the system</span>
  else
    argv = <span class="ruby-string">&quot;&quot;</span>
  end

  output_file = &quot;#{dir}/stdout-#{HelperFunctions.get_random_alphanumeric()}&quot;
  error_file = &quot;#{dir}/stderr-#{HelperFunctions.get_random_alphanumeric()}&quot;

  <span class="ruby-comment"># For most file types, we can use the full path when executing them. For</span>
  <span class="ruby-comment"># programs that run over the JVM (e.g., Java, Scala), we can't - we need </span>
  <span class="ruby-comment"># to change into the directory where the file is located and exec the file </span>
  <span class="ruby-comment"># from there.</span>
  <span class="ruby-comment"># TODO(cgb): Consider a job_data['@jvm_args'] option (with an array val)</span>
  <span class="ruby-comment"># that users can set to pass in arguments that we should pass to the JVM</span>
  <span class="ruby-comment"># we are about to run.</span>
  if executable == <span class="ruby-string">&quot;java&quot;</span> or executable == <span class="ruby-string">&quot;scala&quot;</span>
    dir = <span class="ruby-constant">File</span>.dirname(filename_to_exec)
    file = <span class="ruby-constant">File</span>.basename(filename_to_exec)
    exec_command = &quot;cd #{dir}; #{executable} #{file} #{argv} 1&gt;#{output_file} 2&gt;#{error_file}&quot;
  else
    exec_command = &quot;#{executable} #{filename_to_exec} #{argv} 1&gt;#{output_file} 2&gt;#{error_file}&quot;
  end

  start_time = <span class="ruby-constant">Time</span>.now
  ret_val = <span class="ruby-constant">Djinn</span>.log_run(exec_command)
  end_time = <span class="ruby-constant">Time</span>.now

  total = end_time - start_time
  <span class="ruby-constant">NeptuneManager</span>.log(<span class="ruby-string">&quot;Babel: Done running job!&quot;</span>)
  <span class="ruby-constant">NeptuneManager</span>.log(&quot;TIMING: Took #{total} seconds&quot;)

  <span class="ruby-comment"># Save some data about the task we just ran. At a high level, there are two</span>
  <span class="ruby-comment"># types of information we want to save: debugging information (in case the</span>
  <span class="ruby-comment"># task failed and the user needs to deduce why), and profiling information</span>
  <span class="ruby-comment"># (so the user can see how long their code took to run).</span>

  <span class="ruby-comment"># Add in debugging information.</span>
  job_data[<span class="ruby-string">'@metadata_info'</span>][<span class="ruby-string">'command'</span>] = exec_command
  job_data[<span class="ruby-string">'@metadata_info'</span>][<span class="ruby-string">'return_value'</span>] = ret_val
  job_data[<span class="ruby-string">'@metadata_info'</span>][<span class="ruby-string">'cpu_info'</span>] = <span class="ruby-constant">HelperFunctions</span>.shell(<span class="ruby-string">&quot;cat /proc/cpuinfo&quot;</span>)
  job_data[<span class="ruby-string">'@metadata_info'</span>][<span class="ruby-string">'mem_info'</span>] = <span class="ruby-constant">HelperFunctions</span>.shell(<span class="ruby-string">&quot;cat /proc/meminfo&quot;</span>)
  job_data[<span class="ruby-string">'@metadata_info'</span>][<span class="ruby-string">'df_h'</span>] = <span class="ruby-constant">HelperFunctions</span>.shell(<span class="ruby-string">&quot;df -h&quot;</span>)

  <span class="ruby-comment"># Add in profiling information, with all times converted to seconds since epoch.</span>
  job_data[<span class="ruby-string">'@metadata_info'</span>][<span class="ruby-string">'start_time'</span>] = start_time.to_i
  job_data[<span class="ruby-string">'@metadata_info'</span>][<span class="ruby-string">'end_time'</span>] = end_time.to_i
  job_data[<span class="ruby-string">'@metadata_info'</span>][<span class="ruby-string">'total_execution_time'</span>] = total

  return output_file, error_file
end</pre>
          </div>
          
        </div>

        

        
      </div>

    
      <div id="save_output-method" class="method-detail ">
        <a name="method-c-save_output"></a>

        
        <div class="method-heading">
          <span class="method-name">save_output</span><span
            class="method-args">(remote_output, local_output, job_data)</span>
          <span class="method-click-advice">click to toggle source</span>
        </div>
        

        <div class="method-description">
          
          
          

          
          <div class="method-source-code"
            id="save_output-source">
<pre>
<span class="ruby-comment"># File lib/job_types/babel_helper.rb, line 557</span>
def self.save_output(remote_output, local_output, job_data)
  <span class="ruby-constant">NeptuneManager</span>.log(&quot;Saving local output #{local_output} to remote location #{remote_output}&quot;)
  datastore = <span class="ruby-constant">DatastoreFactory</span>.get_datastore(job_data[<span class="ruby-string">'@storage'</span>], job_data)
  datastore.write_remote_file_from_local_file(remote_output, local_output)
end</pre>
          </div>
          
        </div>

        

        
      </div>

    
      <div id="write_babel_outputs-method" class="method-detail ">
        <a name="method-c-write_babel_outputs"></a>

        
        <div class="method-heading">
          <span class="method-name">write_babel_outputs</span><span
            class="method-args">(output, error, job_data)</span>
          <span class="method-click-advice">click to toggle source</span>
        </div>
        

        <div class="method-description">
          
          <p>Writes the stdout and stderr that a Babel task produces to the remote
datastore that the user has specified to use. We also automatically collect
some metadata about the task, so we write that to the datastore as well.</p>
          

          
          <div class="method-source-code"
            id="write_babel_outputs-source">
<pre>
<span class="ruby-comment"># File lib/job_types/babel_helper.rb, line 517</span>
def self.write_babel_outputs(output, error, job_data)
  datastore = <span class="ruby-constant">DatastoreFactory</span>.get_datastore(job_data[<span class="ruby-string">'@storage'</span>], job_data)

  <span class="ruby-comment"># Write our stdout file</span>
  <span class="ruby-constant">NeptuneManager</span>.log(&quot;Saving stdout at #{output} to remote location&quot; + 
    &quot; #{job_data['@output']}&quot;)
  output_storage_start_time = <span class="ruby-constant">Time</span>.now
  datastore.write_remote_file_from_local_file(job_data[<span class="ruby-string">'@output'</span>], output)

  <span class="ruby-comment"># Write our stderr file</span>
  <span class="ruby-constant">NeptuneManager</span>.log(&quot;Saving stderr #{error} to remote location&quot; +
    &quot; #{job_data['@error']}&quot;)
  datastore.write_remote_file_from_local_file(job_data[<span class="ruby-string">'@error'</span>], error)
  output_storage_end_time = <span class="ruby-constant">Time</span>.now
  total_output_time = output_storage_end_time - output_storage_start_time
  job_data[<span class="ruby-string">'@metadata_info'</span>][<span class="ruby-string">'output_storage_time'</span>] = total_output_time

  local_input_storage_time = job_data[<span class="ruby-string">'@metadata_info'</span>][<span class="ruby-string">'time_to_store_inputs'</span>]
  total_input_time = job_data[<span class="ruby-string">'@metadata_info'</span>][<span class="ruby-string">'input_storage_time'</span>]
  job_data[<span class="ruby-string">'@metadata_info'</span>][<span class="ruby-string">'total_storage_time'</span>] = local_input_storage_time + 
    total_input_time + total_output_time

  end_of_task_time = <span class="ruby-constant">Time</span>.now.to_f
  start_of_task_time = job_data[<span class="ruby-string">'@metadata_info'</span>][<span class="ruby-string">'received_task_at'</span>]
  total_task_time = end_of_task_time - start_of_task_time
  job_data[<span class="ruby-string">'@metadata_info'</span>][<span class="ruby-string">'total_task_time'</span>] = total_task_time

  <span class="ruby-comment"># Write our metadata info, which is not a file, but a hash we will turn to</span>
  <span class="ruby-comment"># a string via JSON</span>
  <span class="ruby-constant">NeptuneManager</span>.log(&quot;Saving metadata #{job_data['@metadata_info'].inspect} &quot; +
    &quot;to remote location #{job_data['@metadata']}&quot;)
  metadata_file = &quot;/tmp/metadata-#{HelperFunctions.get_random_alphanumeric()}&quot;
  <span class="ruby-constant">HelperFunctions</span>.write_file(metadata_file, 
    <span class="ruby-constant">JSON</span>.dump(job_data[<span class="ruby-string">'@metadata_info'</span>]))
  datastore.write_remote_file_from_local_file(job_data[<span class="ruby-string">'@metadata'</span>], 
    metadata_file)
  <span class="ruby-constant">FileUtils</span>.rm_f(metadata_file)
end</pre>
          </div>
          
        </div>

        

        
      </div>

    
    </div>
  

  </div>

  <div id="validator-badges">
    <p><small><a href="http://validator.w3.org/check/referer">[Validate]</a></small></p>
    <p><small>Generated with the <a href="http://deveiate.org/projects/Darkfish-Rdoc/">Darkfish
      Rdoc Generator</a> 2</small>.</p>
  </div>

</body>
</html>

